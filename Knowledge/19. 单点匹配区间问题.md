# 单点匹配区间问题

给定一个长度为 $n$ 的整数序列 $a_i$ 与一个长度为 $n+1$ 的区间序列 $b_i$. 定义 $a_i$ 能匹配 $b_j$ 当且仅当 $a_i \in b_j$, 求有多少个整数 $x$ 满足将 $x$ 加入 $a$ 序列中后 $a_i$ 能与 $b_i$ 形成完美匹配.

$1 \le n \le 3 \times 10^5$, [原题](https://www.luogu.com.cn/problem/CF1718D).

---

考虑 Hall 定理. 假设有一个大小为 $p$ 的区间集合, 所有区间的并为 $S$, 设 $q = \sum_{i} [a_i \in S]$. 显然 $p > q + 1$ 时无解, $p = q + 1$ 时需要 $x \in S$, 否则没有限制.

显然有限制的都是 $p > q$ 的情况, 注意到若 $S$ 不连续, 则 $S$ 中必然有连续的一段满足 $p > q$, 且这个限制更严, 故只需考虑 $S$ 为区间的情况. 又可以立即推出结论, 若有解则可行解一定构成一个区间, 故只需考虑如何求出区间的上下界.

上面的推导是显然的, 重点在下面求上下界的方法.

假设给定了 $x$, 考虑如何判断是否合法. 固然可以用 Hall 定理写线段树直接判, 但我们希望有一种更有拓展性的方法.

考虑从小到大为每个 $a_i$ 寻找尚未被匹配的右端点最小的区间来匹配, 现证明其正确性. 显然对于所有左端点不超过当前的 $a_i$ 的区间, 它们的左端点是等价的, 故现在就把右端点限制最严的区间匹配掉肯定不劣.

现在并没有这个 $x$, 但假设依旧做上述的贪心, 若存在一个 $a_i$ 找不到匹配则无解, 故现在所有的 $a_i$ 都找到了匹配, 故唯一地剩下了一个区间没有被匹配. 我们声称这个区间的右端点就是可行解构成区间的上界, 现证明其正确性. 假设还有一个可行解 $x$ 大于这个区间的右端点 $r$, 那么这个区间一定会匹配上一个 $a_i$. 考虑 $a_i$ 在贪心算法中匹配的区间 $r'$, 一定有 $r' \le r$. 故有 $x > r \ge r'$, $x$ 无法匹配 $r'$ 这个区间. 故只能继续尝试增广, 继续考虑 $r'$ 现在匹配的 $a_{i'}$, 则无论考虑多少层 $x$ 都无法成功增广. 故 $x$ 并非可行解.

类似地, 可以用同样的方法来求得下界. 显然, 当且仅当上界小于下界时无解.

考虑对于求解上界的实现方式. 固然可以对 $a_i$ 升序排序, 对 $b_i$ 的左端点升序排序, 每次往小根堆中加入左端点不超过当前 $a_i$ 的区间的右端点, 然后不断弹堆直到右端点不小于 $a_i$ 为止. [具体代码](https://codeforces.com/contest/1718/submission/312522470)

但也可以对 $a_i$ 升序排序, 对 $b_i$ 的右端点升序排序, 每次往 ``set`` 中加入不超过当前右端点的 $a_i$, 然后在 ``set`` 中找到当前左端点的后继进行匹配. [具体代码](https://codeforces.com/contest/1718/submission/312522571)

时间复杂度均为 $O(n \log n)$, 但前者常数较小.
