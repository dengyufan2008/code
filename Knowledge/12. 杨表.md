# 杨表

给定长度为 $n$ 的序列 $a_i$, $m$ 次询问 $a_i$ 长为 $k$ 的前缀中, 最长的满足 LIS 的长度不超过 $l$ 的子序列的长度.

$1 \le n \le 5 \times 10^4$, $1 \le m \le 2 \times 10^5$.

---

使用 Dilworth 定理将 LIS 长度不超过 $l$ 转化为可用不超过 $l$ 条不增子序列覆盖.

考虑一个序列 $\lambda_i$, 满足 $\lambda_1$ 为 $a_i$ 最长不增子序列的长度, $\lambda_2$ 为删去 $a_i$ 中某一个最长不增子序列 (显然删哪个不会有影响) 后, 最长不增子序列的长度, 以此类推. 显然有 $\sum \lambda_i = n$, 且询问 $l$ 的答案即为 $\sum_{i = 1}^l \lambda_i$.

问题转化为对每个前缀求出 $\lambda_i$, 考虑如下数据结构 $P$ : 第 $i$ 行有 $\lambda_i$ 个单调不增的数, 且这些数的并集为 $\{a_i\}$, 且每次在序列末尾添加一个数 $x$ 时可以动态维护 $\lambda_i$ 的变化. 显然有该数据结构沿主对角线转置后得到的新的 $\lambda'_i$ 序列, 为将前文不增全部改为上升对应的 $\lambda_i$ 序列.

考虑如下维护方式: 对于每一行 $i$, 二分找到第一个 $j$ 满足 $P_{i, j} < x$, 则将 $P_{i, j}$ 与 $x$ 交换, 并继续考虑下一行. 显然对于第一行来说就是二分法求最长不增子序列的过程, 后面的行可以归纳证明. 故每次 $\lambda_i$ 的改变只会发生在恰好一个位置, 且会使这个位置的 $\lambda_i$ 增加 1.

现在我们已经得到了一个 $O(n^2 \log n)$ 地构造 $P$ 的方式, 但无法通过此题. 考虑 $\lambda_i$ 为单调不增的, 则若 $P_{i, j}$ 存在, 有 $ij \le n$. 故 $i$ 与 $j$ 至少有一个不超过 $\sqrt n$.

只维护 $P$ 的前 $\sqrt n$ 行与 $P$ 的转置 $Q$ 的前 $\sqrt n$ 行, 则构造 $P$ 的时间复杂度降为 $O(n \sqrt n \log n)$.

将询问离线后使用树状数组维护 $\lambda_i$ 序列即可.

$O(n \sqrt n \log n + m \log n)$.
