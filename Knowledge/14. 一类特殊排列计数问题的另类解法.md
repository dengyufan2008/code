# 一类特殊排列计数问题的另类解法

给定一个长度为 $m$ 的集合序列 $a_i$, 集合中可能出现的元素为 $[0, n)$. 你需要维护一个集合 $S$, 初始为 $U$, 从 $1$ 到 $m$ 地依次考虑每个 $a_i$, 若 $S \cap a_i \neq S \land S \cap a_i \neq \varnothing$, 则 $S \leftarrow S \cap a_i$, 否则不变. 现在你需要对每个元素 $x \in U$ 求出在 $a_i$ 的 $m!$ 个排列中有多少个 $S$ 最终包含了 $x$. 取模.

$1 \le n \le 20$, $1 \le m \le 10^6$.

---

对 $a_i$ 的排列计数非常烦人, 需要保证每个元素都恰好出现一次. 考虑怎么把这个限制去除掉.

发现一个局面是否对一个元素有贡献只与最终的 $S$ 有关, 故可以只维护 $S$ 而不枚举元素.

注意到, $S$ 的转移只与新加入的元素有关, 且满足非严格 (有自环的 DAG) 的拓扑序 (即集合大小不增), 且满足可复操作性 (类似 checkmin, 多次对同一个元素操作值不变), 则对于这个烦人的限制, 考虑在状态内加入 当前的 $S$ 和 使得 $S$ 不变的未使用的 $a_i$ 数量 和 已经使用过的 $a_i$ 数量. 状态数 $O(2^nm^2)$, 每次转移考虑插入一个不变的 $a_i$ 或者一个会变化的 $a_i$ 并更新不变的数量.

注意到, 由于排列总数为 $n!$, 则可以考虑统计合法的概率, 便可以钦定每次转移 $S$ 都会变化, 并在所有会变化的转移中等概率的选择一个, 则可以省去第二维.

此时无法再记录已经使用过的 $a_i$ 数量, 但发现记这个的作用仅为判断是否是终止状态， 故考虑另一种方式判断是否是终止状态. 记使得 $S$ 变化的 $a_i$ 数量为 $c_S$, 则若一个 $S$ 满足 $c_S = 0$, 其为终止状态. 状态数 $O(2^n)$, 转移考虑枚举 $S$ 的子集 $T$ 满足 $T \neq S \land T \neq \varnothing$, 从 $S$ 转移到 $T$. 设 $trans_{S, T}$ 为 $S$ 有多少个 $a_i$ 会转移到 $T$, 其状态数为 $O(3^n)$. 则转移系数为 $\frac{trans_{S, T}}{c_S}$.

发现 $c_S = \sum_{T \neq S \land T \neq \varnothing} trans_{S, T}$, 故只需求出 $trans_{S, T}$ 即可. 事实上, $trans_{S, T} = \sum_i [S \cap a_i = T]$, 则 $trans_{U, T}$ 是好求的. 考虑从大小较大的转移到大小较小的, 对于一个 $S$ 求出任意一个元素 $x$ 满足 $x \notin S$, 分类讨论是否有 $x \in a_i$, 可得 $trans_{S, T} = trans_{S \cup \{x\}, T} + trans_{S \cup \{x\}, T \cup \{x\}}$.

现在得到了一个时空复杂度均为 $O(3^n)$ 的做法, 考虑优化.

发现瓶颈在于求转移系数和转移, 考虑一种更好的方式刻画转移. 事实上, 转移可以表示为 $\frac{f_S}{c_S} \rightarrow f_{S \cap a_i} \space (S \cap a_i \neq S \land S \cap a_i \neq \varnothing)$. 故可设 $g_S$ 为 $a_i$ 中 $S$ 出现的次数, 转移成为了一个半在线的位与卷积.

距离板子还剩一个 $c_S$ 的求解. 考虑用 $m$ 减去不变的数量, 则对于一个 $a_i$ 来说会对 $S \subseteq a_i$ 和 $S \subseteq U \setminus a_i$ 产生贡献. 高维后缀和即可. $O(n2^n)$.

对于半在线位与卷积 (即 $f_s \times g_t \rightarrow f_{s \cap t}, s \not \subseteq t$), 可以以 $\text{popcount}$ 为拓扑序, 从大往小地递推, 每次将 $\text{popcount} > i$ 的转移到 $\text{popcount} = i$ 的. 故需要做 $O(n)$ 次 $O(n2^n)$ 的 FWT, $O(n^22^n)$.

故总时间复杂度 $O(n^22^n + m)$, 空间复杂度 $O(2^n)$.
