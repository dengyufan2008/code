# 决策单调性

后以 最优决策点是每一行的最小值 为例, 相同时取编号最小.

## 满足决策单调性的矩阵

- 单调矩阵. 单纯的满足决策单调性, 没有好的判定条件.

- 完全单调矩阵. 每个子矩阵都满足决策单调性, 一个判定条件是满足四边形不等式, 即 $A_{i_1, j_1} + A_{i_2, j_2} \le A_{i_1, j_2} + A_{i_2, j_1} \space (i_1 < i_2, j_1 < j_2)$.

  <details><summary>Proof</summary>

  > 根据四边形不等式得到 $A_{i_1, j_1} \le A_{i_1, j_2}$ 或 $A_{i_2, j_2} < A_{i_2, j_1}$. 考虑 $i_1, i_2$ 与 $j_1, j_2$ 对应的子矩阵, 假设前者成立, 则 $i_1$ 行最优决策为 $j_1$, 假设后者成立, 则 $i_2$ 行最优决策为 $j_2$. 故这个子矩阵满足决策单调性, 进而所有 $2*2$ 的子矩阵都满足决策单调性. 考虑所有子矩阵, 假设其不满足决策单调性, 找到任意不满足决策单调性的行二元组, 取出分别的最优决策对应的两列, 则这个 $2*2$ 的子矩阵不满足决策单调性, 故矛盾.
  </details>
  
  称满足四边形不等式的矩阵为 monge 矩阵. 事实上 monge 矩阵有更宽松的判定条件, 即 $A_{i, j} + A_{i+1, j+1} \le A_{i, j+1} + A_{i+1, j}$, 不妨称之为弱四边形不等式, 其等价于四边形不等式.

  <details><summary>Proof</summary>

  > 将四边形不等式变形为 $A_{i_2, j_2} - A_{i_1, j_2} - A_{i_2, j_1} + A_{i_1, j_1} \le 0$. 观察到若将 $A_{i, j}$ 看作某个矩阵 $B_{i, j}$ 从当前格子到左上角的前缀和, 则相当于对于 $B$ 的任意的连续子矩形的和不超过 0. 显然等价于 $B_{i, j} \le 0$, 故四边形不等式等价于弱四边形不等式.
  </details>

## 单调矩阵和完全单调矩阵满足的性质

- 完全单调矩阵是单调矩阵.

- 每行都相等的矩阵和每列都相等的矩阵是完全单调矩阵.

- 单调矩阵的转置依旧是单调矩阵, 完全单调矩阵的转置依旧是完全单调矩阵.

- monge 矩阵的线性组合依旧是 monge 矩阵.

## 区间上的决策单调性

定义一个区间的贡献为 $w(i, j) \space (i \le j)$.

判断 $w(i, j)$ 满足四边形不等式只需考虑定义域内的位置即可, 也即 $i_1 < i_2 < j_1 < j_2$, 也即所谓的 "交叉小于包含".

<details><summary>Proof</summary>

> 将四边形不等式弱化为弱四边形不等式再考虑.
>
> 将 $i > j$ 的位置补全, 值为 $(i-j)^2 M$, 其中 $M$ 大于等于 $w(i, j) \space (i \le j)$ 中的所有数的绝对值, 以及任意两个数的和的绝对值 (即充分大).
>
> 若四边形不等式中取的四个位置均是 $i > j$ 的. 弱四边形不等式等价于 $2(i-j)^2 \le (i-j-1)^2 + (i-j+1)^2$. 左侧加上 $2(i-j)^2$, 右侧加上 $2(i-j)^2-2 = 2(i-j-1)(i-j+1)$, 得到左右均为 $4(i-j)^2$. 故成立.
>
> 若三个位置是 $i > j$ 的, 显然只可能 $i = j+1$. 弱四边形不等式等价于 $2M \le 4M + A_{i, i}$. 显然成立.
>
> 若一个位置是 $i > j$ 的, 显然只可能 $i = j$. 弱四边形不等式等价于 $A_{i, i} + A_{i+1, i+1} \le M + A_{i, i+1}$. 显然成立.
</details>

若 $w(i, j)$ 形如 $F(j-i)$ 的形式, 其中 $F$ 为下凸函数, 则 $w(i, j)$ 满足四边形不等式.

<details><summary>Proof</summary>

> 将四边形不等式变形为 $(j_2 - i_2) - F(j_1 - i_2) \le F(j_2 - i_1) - F(j_1 - i_1)F$. 左右相当于分别以 $j_2 - i_2$ 和 $j_2 - i_1$ 为结尾的长度为 $j_2 - j_1$ 的区间的函数跨度. 显然左边的结尾在右边的结尾的左边, 则区间每往右移动一次跨度都只会增加, 故命题得证.
</details>

区间问题上满足决策单调性的函数: 上文中的 $j-i$ 复合下凸函数, 被区间 $[i, j]$ 包含的关键区间个数 (如逆序对数, 颜色数), $\frac{a_i}{b_j}$ 其中 $a$ 和 $b$ 分别单调不降.

## monge 矩阵最短路

考虑 Dp 方程 $f_{i, t} = \min_{j<i} \{f_{j, t-1} + w(j+1, i)\}$, 相当于求从 1 出发到每个点走 $t$ 步的单源最短路. 假设 $w(i, j)$ 满足四边形不等式, 也即 monge 矩阵.

$f_{i, t}$ 关于 $t$ 是下凸的. 故若只需求解一个 $f_{i, t}$ 的值, 直接 wqs 二分即可.

<details><summary>Proof</summary>

> 只需证明 $2f_{n, t} \le f_{n, t-1} + f_{n, t+1}$ 即可. 考虑从 1 到 $n$ 的两条长度分别为 $t-1$ 和 $t+1$ 的路径, 分别称之 $P$ 和 $Q$, 按编号从小到大写下两条路径经过的结点, 以小写字母区分这个结点由哪条路径经过, 都经过同一个点时认为 $p$ 在 $q$ 之前, 则得到一个长度为 $2t$, 字符集为 $\{p, q\}$ 的序列, 其中有 $t-1$ 个 $p$ 和 $t+1$ 个 $q$.
> 
> 显然序列中存在一个前缀使得 $q$ 的数量比 $p$ 多 2, 比如整个序列作为前缀就满足. 找到第一个这样的前缀 $i$, 则 $i-1$ 与 $i$ 都是 $q$. 若 $i$ 是 $p$, 则 $i-1$ 的前缀中 $q$ 的数量比 $p$ 多 3, 而空串 $q$ 的数量与 $p$ 的数量相等, 必然前面还有一个位置是多 2, 矛盾; 若 $i-1$ 是 $p$, 则 $i-2$ 的前缀 $q$ 比 $p$ 多 2, 矛盾.
> 
> 设 $i-1$ 之前的最靠近 $i-1$ 的 $p$ 的下标为 $j$, $i$ 之后的最靠近 $i$ 的 $p$ 的下标为 $k$. 将 $i$ 以及 $i$ 之后的所有字符翻转 ($p$ 变 $q$, $q$ 变 $p$). 若 $i-1$ 和 $j$ 对应的位置相同则变化量为 0, 否则两条路径的权值总和的变化量为 $-w(j, k) - w(i-1, i) + w(j, i) + w(i-1, k)$, 需要将式子中的下标替换为对应的位置, 显然四个位置都不同, 由于四边形不等式, 变化量一定非正. 故一定存在两条长度为 $t$ 的路径和不超过长度为 $t-1$ 的路径与长度为 $t+1$ 的路径的和.
</details>

## 求解决策单调性的算法

- 分治. 只需满足单调矩阵即可, 但是是离线的.

- 二分栈. 需要满足完全单调矩阵, 但是是在线的.

- SMAWK 算法. 需要满足完全单调矩阵, 而且是离线的, 但是不带 log. 算法流程是先递归算偶数行的最优决策点, 然后奇数行的就可以 $O(n+m)$ 算. 发现这样是 $O(n + m \log n)$ 的, 于是每次先用类似二分栈的方式找到可能用到的 $n$ 列, 则将 $m$ 缩减到了 $n$, 每次 $O(n)$ 计算, 复杂度 $O(n)$.
