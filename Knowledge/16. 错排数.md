# 错排数

计数长度为 $n$ 的排列 $p_i$, 满足 $p_i \neq i \space (i \le m)$.

$1 \le n \le 10^7$, $0 \le m \le n$.

---

考虑 $n = m$ 如何做. 事实上即为常规定义的错排数 $D(n)$.

设 $f_i$ 表示 $n = m = i$ 时的答案. 设 $p_i = x \neq i$, 分类讨论 $p_x$ 与 $i$ 的关系.

- $p_x = i$
  
  显然可以将 $i$ 与 $x$ 一同删去, 方案数为 $f_{i-2}$.

- $p_x \neq i$

  执行 $\text{swap}(p_i, p_x)$, 则有 $p_i \neq i$, $p_x = x$. 可以将 $x$ 删去, 方案数为 $f_{i-1}$.

$x$ 有 $i-1$ 种取值, 总递推式为

$$f_i = (i-1)(f_{i-2}+f_{i-1})$$

现在考虑一般情况, 设 $g_{i, j}$ 表示 $n = i$, $m = j$ 时的答案. 我们希望通过分类讨论某个特殊位置的值使得能够删去几个位置.

显然第 $j$ 个比第 $i$ 个更加特殊 (多了一个不等关系). 设 $p_j = x \neq j$, 分类讨论 $p_x$ 与 $j$ 的关系.

- $p_x = j$
  
  同样的一同删去 $j$ 和 $x$, 发现为了维护 $j$ 需要额外讨论 $x$ 与 $j$ 的关系来判断 $j$ 减少 1 还是 2.

此处省略另一种分类讨论. 发现我们需要分类讨论 $2 \times 2 = 4$ 种情况, 导致转移方程中有四项, 这显然是不优美且难以优化的. 注意到促使我们选择分类讨论第 $j$ 个位置的原因是这样多了一个条件, 即 $x \neq j$. 但略加思考我们发现设 $p_x = j$ 也能满足 $x \neq j$, 而且无需讨论第一个分支, 故有了一个新的思路.

设 $p_x = j \neq x$, 分类讨论 $x$ 与 $j$ 的关系.

- $x < j$

  考虑 $p_j$ 与 $x$ 的关系是未知的, 且我们不希望引入更多的分类讨论, 故试图将 $j$ 删去. 直接进行 $\text{swap}(p_x, p_j)$, 发现我们并不能满足 $p_x \neq x$, 不过此时我们的下标多了一维, 只需考虑 $j$ 的变化即可. 由于 $j$ 被删去, $x$ 不再需要满足不等条件, 故 $j$ 应当减去 2, 方案数恰好为 $g_{i-1, j-2}$.

- $x > j$

  同理, 但 $x$ 本就不需要满足不等条件, 方案数为 $g_{i-1, j-1}$.

$x$ 分别有 $j-1$, $i-j$ 种取值, 总递推式为

$$g_{i, j} = (j-1)g_{i-1, j-2} + (i-j)g_{i-1, j-1}$$

此时获得了一个 $O(nm)$ 的做法, 考虑进一步优化. 发现递推式只与 $G_i$ 和 $G_{i-1}$ 有关, 考虑能否推导出一个新的二者的关系. 我们不选择推导 $G(j)$, $G(j-1)$ 和 $G(j-2)$ 的关系显然是因为三元需要额外的两个关系, 更难以找到.

既然我们想在 $i$ 一维移动量尽量的少, 不妨考虑以 $j$ 为拓扑序 Dp. 发现 $G_i$ 随 $j$ 单调不增, 考虑 $j$ 从大到小转移, 可以使式子中尽量出现加号. 推导 $g_{i, j-1}$ 满足的式子, 分类讨论 $p_j$ 与 $j$ 的关系.

- $p_j = j$

  将 $j$ 删去, 方案数为 $g_{i-1, j-1}$.

- $p_j \neq j$

  方案数显然为 $g_{i, j}$.

故有

$$g_{i, j-1} = g_{i-1, j-1} + g_{i, j}$$

发现两个递推式共与 $g_{i, j}$, $g_{i, j-1}$, $g_{i-1, j-1}$ 和 $g_{i-1, j-2}$ 有关, 不妨改写 $G_{i-1}$ 的下标, 全部减 1. 设 $p_i = g_{n, i}$, $q_i = g_{n-1, i-1}$, 有

$$
\begin{aligned}
p_i &= (i-1)q_{i-1} + (n-i)q_i
\\
p_{i-1} &= p_i + q_i
\end{aligned}
$$

发现两个式子中 $i-1$ 项都只出现了一种, 故将式子改写为从 $i$ 转移到 $i-1$ 的形式.

$$
\begin{aligned}
p_{i-1} &= p_i + q_i
\\
q_{i-1} &= \frac{p_i-(n-i)q_i}{i-1}
\end{aligned}
$$

其中 $p_n = f_n$, $q_n = f_{n-1}$.

$$f_i = (i-1)(f_{i-2}+f_{i-1})$$

其中 $f_0 = 1$, $f_1 = 0$.

$O(n)$.
