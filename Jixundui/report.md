# 集你太美 (collect, 2s, 512M)

## 题目大意

给定一张 $n$ 个结点的无向完全图 $G$, 结点编号从 1 开始, 边 $(i, j)$ 带非负整数权 $v_{i, j}$, 保证 $v_{i, i} = 0$, $v_{i, j} = v_{j, i}$.

假设每个点有非负整数点权 $w_i$, 定义对一个点 $i$ 进行一次 **收集操作** 为, 将 $w_i$ 的值加上 $\sum_j v_{i, j}$, 并将 $w_j$ 的值减去 $v_{i, j}$. 称一次对点 $i$ 的收集操作 **合法**, 当且仅当 $w_j \ge v_{i, j}$.

称一组非负整数点权 $w_i$ **合法**, 当且仅当存在一种方式可以进行无限次合法的收集操作.

你需要在 **最小化** $\sum_i w_i$ 的情况下, 构造一组合法的非负整数点权 $w_i$.

## 数据范围

令 $m$ 为边权非 0 的边数.

保证对于所有数据, 满足 $1 \le n \le 10^6$, $0 \le m \le \min(2 \times 10^6, {n(n-1) \over 2})$, $0 \le v_{i, j} \le 10^9$.

## 解题过程

### 约定

若 $G$ 不连通, 则显然可以只关注其中的一个连通块, 并将不在这个连通块的点权设为 0, 最终答案即为每个连通块各自独立的答案的最小值. 故下文假定 $G$ **连通**.

我们不再认为 $v_{i, j}$ 是一条边的边权, 而是连接了点 $i$ 与点 $j$ 的边权为 1 的边的 **数量**. 显然这不改变收集操作对局面的影响. 故下文假定每条边的边权都为 1, 并且不再强调边权.

用 **收集-free** 指代一个局面存在一种方式能够进行无限次合法的收集操作, 用 **局面** 指代 $w_i$ 序列.

### 准备工作

我们先对收集操作进行观察. 发现一个收集操作合法的条件与所有非自身的点的点权有关, 较为复杂. 于是我们可以想到与收集操作对称的另一个操作, 称为扩散操作.

形式化地定义, 对一个点 $i$ 进行一次 **扩散操作** 为, 将 $w_i$ 的值减去 $\sum_j v_{i, j}$, 并将 $w_j$ 的值加上 $v_{i, j}$. 称一次对点 $i$ 的扩散操作 **合法**, 当且仅当 $w_i \ge \sum_j v_{i, j}$.

容易发现扩散操作和收集操作互为 **逆操作**. 类似地, 用 **扩散-free** 指代一个局面存在一种方式能够进行无限次合法的扩散操作.

---

由于进行操作伴随着局面的变化, 故如果我们想考虑不同的局面之间的关系的话, 需要一个更好的结构来帮助思考.

容易想到可以对图 $G$ 定义一张 **局面图** $\mathcal{G}$. 也即, 将每个不同的局面视为一个结点, 如果一个局面 $A$ 能够通过 **一次合法的扩散操作** 变为另一个局面 $B$, 则 $\mathcal{G}$ 中有 $A$ 向 $B$ 的 **有向边**.

### 求解

类似准备工作中的思路, 我们希望把求解, 收集-free 的局面中 $\sum_i w_i$ 的最小值, 变为, 扩散-free 的局面中 $\sum_i w_i$ 的最小值. 为此, 考虑在 $\mathcal{G}$ 中找出哪些局面是 收集-free 的, 以及哪些局面是 扩散-free 的.

先考虑 收集-free 的局面, 对应在 $\mathcal{G}$ 上逆向行走. 则 收集-free 的局面有且仅有 强连通分量内的局面以及强连通分量能够到达的局面. 类似地, 扩散-free 的局面有且仅有 强连通分量内的局面以及能够到达强连通分量的局面.

---

Lemma 1. 如果一个局面是 扩散-free 的, 那么在无限次进行合法的扩散操作的过程中, **所有点** 都会被操作无限次.

Proof. 假设存在一些点只会被操作有限次, 任取一个这样的点组成的连通块 $G'$. 显然 $G$ 中至少有一个点会被操作无限次, 且 $G$ 连通, 故 $G'$ 一定有一个会被操作无限次的邻点 $v$.

记 $S = \sum_{i \notin G'} w_i$. 容易发现, $S$ 只有在对 $G'$ 内的点操作时才会增加, 故 $S$ 只会增加有限次, 但每次对 $v$ 进行操作时 $S$ 都会减少, 故 $S$ 会减少无限次. 又有 $S$ 始终非负, 故矛盾.

---

Lemma 2. $\mathcal{G}$ 中强连通分量内的局面, **出边** 指向的 **所有局面** 都在强连通分量内.

Proof. 取一个强连通分量内的局面 $A$, 以及它通过对点 $u$ 进行扩散操作到达的另一个局面 $B$. 我们只需要证明 $B$ 能够通过若干次扩散操作到达 $A$, 即可证明上述命题.

取一个经过 $A$ 的简单环, 假设这个环的长度为 $k$, 从 $A$ 开始沿着这个环走一圈所进行的扩散操作序列为 $v_1, v_2, \cdots, v_k$. 根据 Lemma 1, $v_i$ 一定包含了 $G$ 中的所有结点, 故存在一个下标 $1 \le p \le k$ 使得 $v_p = u$ 且对于任意的 $1 \le i < p$ 有 $v_i \neq u$.

考虑一个新的长度为 $k$ 的从 $A$ 开始的操作序列 $v'$, 满足 $v'_1 = u$, 对于 $1 \le i < p$ 有 $v'_{i+1} = v_i$, 对于 $p < i \le k$ 有 $v'_i = v_i$. 现证明从 $A$ 开始的操作序列 $v'$ 合法.

显然只需证明前 $p$ 次操作均合法即可. 由假设得第一次操作合法, 且剩下的 $p-1$ 次操作都不是对于 $u$ 进行的操作. 由于扩散操作合法只与进行操作的那个点的点权有关, 且点权越大越容易合法, 且如果不进行第一次操作, 依次进行剩下的 $p-1$ 个操作合法, 故前 $p$ 次操作合法. 故上述命题得证.

---

根据 Lemma 2, 收集-free 的局面有且仅有 强连通分量内的局面. 进一步, 收集-free 的局面 **都是** 扩散-free 的局面.

这是符合我们在准备工作中的认识的, 因为扩散操作合法的条件显得更加宽松. 由此, 收集-free 的局面中 $\sum_i w_i$ 的最小值 **大于等于** 扩散-free 的局面中 $\sum_i w_i$ 的最小值.

---

于是, 我们可以开始考虑 扩散-free 的局面中 $\sum_i w_i$ 的下界.

由于局面会不断地改变, 我们希望将 $\sum_i w_i$ 对应到其他不会改变的量上面去.

为了方便对应, 我们认为每 1 单位的点权都是 **互不相同** 的. 对一个点 $i$ 进行扩散操作时, 我们可以选取 $i$ 已有的点权中的任意一部分, 并任意地将它们分配给其他点, 只要总的数量满足操作规则即可.

我们称一条边一定处于两种不同的状态之一, 分别为 **未分配** 和 **已分配**. 所有的边初始状态为未分配. 当我们对一个点 $i$ 进行扩散操作时, 若 $i$ 连接的边中存在一条边是未分配的, 则认为这次操作通过这条边移动到邻点的那 1 单位的点权被 **分配** 到了这条边上, 并将这条边的状态改为已分配; 若 $i$ 连接的边中存在一条边是已分配的, 则我们将这条边被分配的那 1 单位的点权通过这条边移动到邻点去.

显然操作了点 $i$ 之后, 它连接的所有的边的状态都是已分配.

显然当 1 单位的点权被分配到了某一条边上之后, 这 1 单位的点权就只会在这条边的两个端点间通过这条边移动. 故每条已分配的边, 所被分配的点权 **互不相同**.

根据 Lemma 1, 在无限次进行合法的扩散操作的过程中, 所有点都会被操作至少一次. 故一定存在一个时刻, 在这个时刻之后每条边的状态都是已分配. 由于每条边被分配的点权互不相同, 则 扩散-free 的局面 $\sum_i w_i$ 的下界为 $m$.

由于收集-free 的局面中 $\sum_i w_i$ 的最小值大于等于扩散-free 的局面中 $\sum_i w_i$ 的最小值, 故 收集-free 的局面 $\sum_i w_i$ 的下界也为 $m$.

现在考虑 收集-free 的局面 $\sum_i w_i$ 能否取到 $m$. 容易发现, 如果我们对 $G$ 中的每条无向边 **定向**, 使得定向后的图成为一个 **DAG**, 将每个点的点权设为它的入度, 则这个局面是 收集-free 的.

具体地, 我们可以每次任取一个入度为 0 的结点, 对它进行收集操作, 显然这次操作是合法的. 那么它的所有出边都会 **反向** 为入边.

---

Lemma 3. 在 DAG 中将一个入度为 0 的结点 $v$ 的所有出边反向, 得到的新图也是一张 DAG.

Proof. 只需证明新图无环即可. 假设新图有环. 如果这个环没有经过 $v$, 则可以在原图与新图中同时删去结点 $v$, 则两张图变得相同. 显然原图没有环, 故新图也不会有环, 矛盾; 如果这个环经过 $v$, 但我们知道新图中 $v$ 没有出边, 矛盾.

---

根据 Lemma 3, 操作之后这张定向后的图依旧是 DAG, 故可以进行无限次合法的收集操作.

因此, 收集-free 的局面中 $\sum_i w_i$ 的最小值为 **边数**, 也即 $\sum_{i, j} v_{i, j}$. 具体的构造方法在上文中已给出.

### 检查

由于这是一道构造题, 还需要给出 **判断** 一个局面是否是 收集-free 的方式.

### 总结

至此, 我们就对每个用到的关键结论进行了简单的证明, 并用 **线性** 的时空复杂度解决了构造与检查两部分问题.

## 参考资料
