T1

发现直接从大往小贪心是错的，思考一下可以发现，虽然答案的每个区间里如果有更大的包含的数没选一定可以替换，但是先选大的可能导致最后选的个数没有之前多。

所以先三分个数，然后就贪心需要满足两个 Hall 的最大权值，就按照第一个 Hall 每次贪心从 $\leq p_i$ 的里面选没选过的最大的，然后用 set 维护第二个 Hall 判断能不能选。

T2

把原问题改成，如果抽超过 $b_i$ 个，就把这张扔进弃牌堆。然后设手上的牌有 $x$ 个，弃牌堆有 $y$ 个，抽卡一次花费的时间是 $\frac{M-x}{M-x-y}$。

然后对 $x,y$ 做背包。$f(i,j,k)$ 表示确定了前 $i$ 个，$x=j,y=k$ 的概率，然后每次转移枚举 $i$ 放了多少个，$j'=j+\min(c,b_i)$，$k'=k+\max(0,c-b_i)$，然后用组合数算一下概率。这个是三次方的。

然后发现最后的时间分母上是 $x+y$，所以只用把 $x+y$ 记状态里，分子的 $M-x$ 的 $-x$ 看做可以在转移过程中钦定一个 $\min(c,b_i)$，多记录一维 $0/1$ 就行。然后平方了，卷积可以 $O(M\log^2 M)$。

T3

先分块，每个块求出所有包含整块的边然后连一个并查集。找到与这个块交集不是空的 $O(L)$ 条边，然后现在的问题是要对每个块求出这 $O(L)$ 个关键点在块内连通了多久。暴力是 $O(BL^3)=O(nL^2)$ 的，平衡一下是 $O(n^{5/3})$，能做一些分。

然后块内的问题相当于 $B$ 个 $n=m=O(L),q=O(L^2)$ 的原问题，考虑继续分块。按照 $\sqrt L$ 分块能做到 $O(不会算)$ 复杂度，应该过不去。发现 $q=O(L^2)$ 的时候按照 $L/2$ 分块的复杂度是 $T(n)=2T(n/2)+O(n^2)$，所以就变成 $O(BL^2)=O(nL)$ 了，平衡一下是单根号。