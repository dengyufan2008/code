# [A task for substrings](https://www.luogu.com.cn/problem/CF1801G) 题解

给出一个使用 SAM 的离线做法.

设询问的左右端点为 $[L, R]$, 模式串的出现位置为 $[l, r]$. 要求 $L \le l \le r \le R$ 的个数, 即 $r \le R$ 的个数减去 $l < L \land r \le R$ 的个数.

对 $t$ 的正串建立 SAM.

考虑第一部分. 将询问按 $R$ 升序排序, 维护只考虑当前前缀的所有模式串出现个数. 每次相当于加入一个可用的 endpos 元素, 对答案的增量为 fail 树上对应链上的模式串结束结点个数, 差分预处理容易求得.

考虑第二部分. 对于串长 $> R - L + 1$ 的模式串, 限制条件为 $r \le R$, 而串长 $\le R - L + 1$ 的模式串限制条件为 $l < L$. 故对所有模式串按串长排序, 分界点二分求得, 从而将询问 $[L, R]$ 拆成两个询问并离线.

先考虑第一类询问, 对每个后缀的模式串求出在 $t$ 的一个前缀内的出现次数. 将询问按分界点降序排序, 同时枚举询问和模式串, 如同第一部分地子树加, 但此时需要在线地对于叶子序列前缀求和. 使用树状数组或线段树容易解决.

对于第二类询问, 求出每个串在 $t$ 中的出现次数并变为 $l \ge L$ 的限制. 对 $t$ 的反串建立 SAM, 将所有模式串反向并反转, 则归约至第一类询问.

第一部分时间复杂度为 $O(m \log m + |t| + \sum |s|)$, 第一类询问时间复杂度为 $O(m \log mn|t| + n \log n|t|)$, 第二类询问归约至第一类时间复杂度为 $O(|t| + \sum |s|)$.

故总时间复杂度为 $O(m \log mn|t| + n \log n|t| + |t| + \sum |s|)$, 空间复杂度 $O(m + |t| + \sum |s|)$.
